# ============================================================
# MPPI (Model Predictive Path Integral) 控制器配置
# 特点: 高精度、复杂环境避障、高计算量（建议 GPU）
# ============================================================

controller_server:
  ros__parameters:
    controller_frequency: 30.0
    min_x_velocity_threshold: 0.001
    min_y_velocity_threshold: 0.5
    min_theta_velocity_threshold: 0.001
    failure_tolerance: 0.3
    progress_checker_plugins: ["progress_checker"]
    goal_checker_plugins: ["general_goal_checker"]
    controller_plugins: ["FollowPath"]

    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
      required_movement_radius: 0.5
      movement_time_allowance: 10.0

    general_goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25
      stateful: True

    FollowPath:
      plugin: "nav2_mppi_controller::MPPIController"
      
      # 时间和批次参数
      time_steps: 56
      model_dt: 0.05
      batch_size: 2000
      
      # 采样噪声标准差
      vx_std: 0.2
      vy_std: 0.0
      wz_std: 0.4
      
      # 速度限制
      vx_max: 0.5
      vx_min: -0.35
      vy_max: 0.0
      wz_max: 1.9
      
      # 迭代参数
      iteration_count: 1
      prune_distance: 1.7
      transform_tolerance: 0.1
      
      # MPPI 核心参数
      temperature: 0.3
      gamma: 0.015
      
      # 运动模型 (DiffDrive, Omni, Ackermann)
      motion_model: "DiffDrive"
      
      # 可视化
      visualize: false
      
      # 重置参数
      reset_period: 1.0
      regenerate_noises: false
      
      # 轨迹可视化（如果 visualize: true）
      TrajectoryVisualizer:
        trajectory_step: 5
        time_step: 3
      
      # Ackermann 约束（仅当 motion_model: Ackermann 时使用）
      AckermannConstraints:
        min_turning_r: 0.2
      
      # 评分函数（Critics）
      critics: [
        "ConstraintCritic",
        "ObstaclesCritic", 
        "GoalCritic",
        "GoalAngleCritic",
        "PathAlignCritic",
        "PathFollowCritic",
        "PathAngleCritic",
        "PreferForwardCritic"
      ]
      
      # 约束评分
      ConstraintCritic:
        enabled: true
        cost_weight: 4.0
        cost_power: 1
      
      # 目标评分
      GoalCritic:
        enabled: true
        cost_weight: 5.0
        cost_power: 1
        threshold_to_consider: 1.4
      
      # 目标角度评分
      GoalAngleCritic:
        enabled: true
        cost_weight: 3.0
        cost_power: 1
        threshold_to_consider: 0.5
      
      # 前进偏好评分
      PreferForwardCritic:
        enabled: true
        cost_weight: 5.0
        cost_power: 1
        threshold_to_consider: 0.5
      
      # 障碍物评分
      ObstaclesCritic:
        enabled: true
        cost_weight: 1.0
        repulsion_weight: 0.1
        critical_weight: 20.0
        consider_footprint: false
        collision_cost: 10000.0
        collision_margin_distance: 0.1
        near_goal_distance: 0.5
        inflation_layer_name: "inflation_layer"
      
      # 路径对齐评分
      PathAlignCritic:
        enabled: true
        cost_weight: 14.0
        cost_power: 1
        max_path_occupancy_ratio: 0.05
        trajectory_point_step: 3
        threshold_to_consider: 0.5
        offset_from_furthest: 20
        use_path_orientations: false
      
      # 路径跟随评分
      PathFollowCritic:
        enabled: true
        cost_weight: 5.0
        cost_power: 1
        offset_from_furthest: 5
        threshold_to_consider: 1.4
      
      # 路径角度评分
      PathAngleCritic:
        enabled: true
        cost_weight: 2.0
        cost_power: 1
        offset_from_furthest: 4
        threshold_to_consider: 0.5
        max_angle_to_furthest: 1.0
        mode: 0  # 0: 前向, 1: 双向
